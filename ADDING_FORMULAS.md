# Adding New Formulas to This Tap

This guide explains how to add new formulas to this personal Homebrew tap.

## Table of Contents

- [Prerequisites](#prerequisites)
- [Method 1: Using `brew extract` (Recommended)](#method-1-using-brew-extract-recommended)
- [Method 2: Manual Formula Creation](#method-2-manual-formula-creation)
- [Formula Validation](#formula-validation)
- [Testing the Formula](#testing-the-formula)
- [Committing the Formula](#committing-the-formula)
- [Decision Framework](#decision-framework)

---

## Prerequisites

Before adding a formula, ensure you have:

1. Homebrew installed and up to date:
   ```bash
   brew update
   ```

2. This tap repository cloned locally:
   ```bash
   git clone https://github.com/dsaenztagarro/homebrew-tap.git
   cd homebrew-tap
   ```

3. The tap tapped locally:
   ```bash
   brew tap dsaenztagarro/tap
   ```

---

## Method 1: Using `brew extract` (Recommended)

`brew extract` is the official Homebrew command for creating versioned copies of formulas. This is the recommended approach.

### Step 1: Find the Formula Version

First, identify the version you want to extract:

```bash
# Check the current version in homebrew-core
brew info <formula-name>

# Example:
brew info openssl@3
```

### Step 2: Find the Git Commit (Optional but Recommended)

For maximum reproducibility, find the specific commit in homebrew-core:

```bash
# Navigate to homebrew-core repository
cd $(brew --repository homebrew/core)

# Find commits for the formula
git log --oneline Formula/<first-letter>/<formula-name>.rb | head -20

# Example for openssl@3:
git log --oneline Formula/o/openssl@3.rb | head -20
```

Look for a commit that matches your desired version.

### Step 3: Extract the Formula

Use `brew extract` to create the formula in your tap:

```bash
# Basic extraction (latest version)
brew extract <formula-name> dsaenztagarro/tap

# Extract specific version (recommended)
brew extract --version=<version> <formula-name> dsaenztagarro/tap

# Extract from specific commit (most reproducible)
brew extract --version=<version> --git-revision=<commit> <formula-name> dsaenztagarro/tap

# Examples:
brew extract --version=3.2.0 openssl@3 dsaenztagarro/tap
brew extract --version=3.2.0 --git-revision=abc1234 openssl@3 dsaenztagarro/tap
```

### Step 4: Add Metadata Header

Navigate to the extracted formula and add documentation:

```bash
cd $(brew --repository dsaenztagarro/tap)
cd Formula
```

Edit the formula file (e.g., `openssl@3.2.0.rb`) and add a header:

```ruby
# Formula for openssl@3
# Version: 3.2.0
# Extracted date: YYYY-MM-DD
# Extraction command: brew extract --version=3.2.0 --git-revision=abc1234 openssl@3 dsaenztagarro/tap
# Source: homebrew/core commit abc1234
# Homebrew core URL: https://github.com/Homebrew/homebrew-core/blob/abc1234/Formula/o/openssl@3.rb
# Reason: [Why this specific version? e.g., "Stable version compatible with Ruby 3.2"]
# Tested on: macOS 14 (Sonoma) - arm64

class OpensslAT320 < Formula
  # ... rest of formula (auto-generated by brew extract)
end
```

---

## Method 2: Manual Formula Creation

For formulas not in homebrew-core, or for custom formulas:

### Step 1: Create Formula File

```bash
cd $(brew --repository dsaenztagarro/tap)/Formula
touch <formula-name>.rb
```

### Step 2: Write the Formula

Use the standard Homebrew formula template:

```ruby
# Formula for <package-name>
# Version: X.Y.Z
# Created date: YYYY-MM-DD
# Source: [upstream URL or description]
# Reason: [Why this formula is needed]
# Tested on: [OS and architecture]

class PackageName < Formula
  desc "Short description of the package"
  homepage "https://package-homepage.com"
  url "https://download-url.com/package-x.y.z.tar.gz"
  sha256 "sha256-checksum-here"
  license "LICENSE-TYPE"

  # Build dependencies (only needed during build)
  depends_on "cmake" => :build
  depends_on "pkg-config" => :build

  # Runtime dependencies
  depends_on "other-package"

  def install
    # Installation steps
    system "./configure", "--prefix=#{prefix}"
    system "make"
    system "make", "install"
  end

  test do
    # Test to verify installation
    system "#{bin}/package", "--version"
  end
end
```

### Step 3: Calculate SHA256 Checksum

```bash
# Download the source file
curl -L -O <download-url>

# Calculate SHA256
shasum -a 256 <filename>
```

---

## Formula Validation

Before committing, validate the formula:

### 1. Audit the Formula

```bash
brew audit --strict --online <formula-name>

# Example:
brew audit --strict --online dsaenztagarro/tap/openssl@3
```

### 2. Check Formula Style

```bash
brew style <formula-path>

# Example:
brew style Formula/openssl@3.rb
```

### 3. Run Formula Tests (if available)

```bash
brew test <formula-name>

# Example:
brew test dsaenztagarro/tap/openssl@3
```

---

## Testing the Formula

### 1. Install from Source

```bash
# Install and build from source
brew install --build-from-source dsaenztagarro/tap/<formula-name>

# Example:
brew install --build-from-source dsaenztagarro/tap/openssl@3
```

### 2. Verify Installation

```bash
# Check installation
brew info <formula-name>

# Verify the binary works
<binary-name> --version

# Example:
openssl version
```

### 3. Test with Dependent Projects

If the formula is a dependency for your projects, test integration:

```bash
cd /path/to/your/project
bundle install  # or equivalent for your project
# Run project tests
```

### 4. Check for Conflicts

```bash
brew doctor
```

---

## Committing the Formula

### 1. Review Changes

```bash
cd $(brew --repository dsaenztagarro/tap)
git status
git diff
```

### 2. Add and Commit

```bash
# Add the formula
git add Formula/<formula-name>.rb

# Commit with descriptive message
git commit -m "Add <formula-name> formula (version X.Y.Z)

- Short description of the package
- Version: X.Y.Z
- SHA256: <checksum>
- Source: [source information]
- Reason: [why this formula is added]
- Tested on: [OS and architecture]"

# Example:
git commit -m "Add postgresql@14 formula (version 14.10)

- PostgreSQL database server
- Version: 14.10
- SHA256: abc123...
- Source: homebrew/core commit def456
- Reason: Stable database version for development projects
- Tested on: macOS 14 (Sonoma) - arm64"
```

### 3. Push to Repository

```bash
git push origin main
```

---

## Decision Framework

### When to Add a Formula

✅ **Should Add:**
- Critical development dependencies (databases, SSL libraries, language runtimes)
- Tools used frequently across multiple projects
- Packages requiring specific version pinning
- Security-sensitive packages requiring controlled updates
- Tools with breaking changes between versions
- Build-time dependencies for personal projects

❌ **Should NOT Add:**
- Tools rarely used
- Packages with stable APIs that rarely break
- Packages better managed by other package managers (npm, gem, pip, cargo)
- Experimental or bleeding-edge tools (unless specifically needed)
- Packages that update daily/weekly (maintenance burden)

### Evaluation Checklist

Before adding a formula, ask:

- [ ] Do I use this tool regularly?
- [ ] Is version pinning important for this tool?
- [ ] Will this formula help maintain consistent environments?
- [ ] Can I maintain this formula (security updates, version bumps)?
- [ ] Is this the right package manager for this tool?

---

## Examples

### Example 1: Extracting Redis

```bash
# Find the version you want
brew info redis

# Extract specific version
brew extract --version=7.2.3 redis dsaenztagarro/tap

# Navigate to formula
cd $(brew --repository dsaenztagarro/tap)/Formula

# Add metadata header to redis@7.2.3.rb
# Then commit
git add redis@7.2.3.rb
git commit -m "Add redis formula (version 7.2.3)

- Redis in-memory data structure store
- Version: 7.2.3
- Source: homebrew/core
- Reason: Cache and job queue for development projects
- Tested on: macOS 14 (Sonoma) - arm64"
```

### Example 2: Adding AWS CLI

```bash
# Extract latest version from homebrew-core
cd $(brew --repository homebrew/core)
git log --oneline Formula/a/awscli.rb | head -10

# Extract with commit for reproducibility
brew extract --version=2.13.25 --git-revision=xyz9876 awscli dsaenztagarro/tap

# Add metadata and commit
cd $(brew --repository dsaenztagarro/tap)
# Edit Formula/awscli@2.13.25.rb to add metadata header
git add Formula/awscli@2.13.25.rb
git commit -m "Add awscli formula (version 2.13.25)

- Official Amazon AWS command-line interface
- Version: 2.13.25
- SHA256: [checksum]
- Source: homebrew/core commit xyz9876
- Reason: AWS infrastructure management tool
- Tested on: macOS 14 (Sonoma) - arm64"
```

---

## Troubleshooting

### Issue: "Formula not found" during extraction

**Cause:** The formula or version doesn't exist in homebrew-core history.

**Solution:**
```bash
# Check if formula exists
brew search <formula-name>

# Check available versions in git history
cd $(brew --repository homebrew/core)
git log --all --oneline -- Formula/<letter>/<formula-name>.rb
```

### Issue: "Permission denied" during extraction

**Cause:** No write access to tap repository.

**Solution:**
```bash
# Check repository permissions
cd $(brew --repository dsaenztagarro/tap)
ls -la
git remote -v
```

### Issue: Formula installs but wrong version

**Cause:** Class name doesn't match filename.

**Solution:**
```bash
# Ensure filename matches class name
# File: openssl@3.2.0.rb
# Class: class OpensslAT320 < Formula
```

### Issue: Audit failures

**Cause:** Formula doesn't meet Homebrew standards.

**Solution:**
```bash
# Run audit to see specific issues
brew audit --strict --online <formula-name>

# Fix reported issues in formula file
# Common issues: missing license, incorrect URLs, style violations
```

---

## Best Practices

1. **Always use `brew extract` with `--git-revision`** for maximum reproducibility
2. **Add comprehensive metadata headers** to document extraction details
3. **Test formulas thoroughly** before committing
4. **Use semantic commit messages** that explain why the formula was added
5. **Document the reason** for choosing a specific version
6. **Keep formulas updated** with security patches
7. **Remove unused formulas** to reduce maintenance burden
8. **Maintain at least 2 versions** during transition periods

---

## Resources

- [Homebrew Documentation](https://docs.brew.sh/)
- [brew extract Manual](https://docs.brew.sh/Manpage#extract-options-formula-tap)
- [Formula Cookbook](https://docs.brew.sh/Formula-Cookbook)
- [How to Create a Tap](https://docs.brew.sh/How-to-Create-and-Maintain-a-Tap)
- [Homebrew Formula Documentation](https://rubydoc.brew.sh/Formula)

---

**Last Updated:** 2025-11-14  
**Maintained by:** David Saenz Tagarro
